#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Script de Instala√ß√£o - Quality Remote Agent
Instala e configura o agente Quality com verifica√ß√£o de servi√ßos instalados
"""

import os
import sys
import json
import shutil
import subprocess
from pathlib import Path
from typing import Dict, Any, List

def print_banner():
    """Exibe banner de instala√ß√£o"""
    print("=" * 60)
    print("üöÄ QUALITY REMOTE AGENT - INSTALA√á√ÉO")
    print("=" * 60)
    print("Sistema de monitoramento e controle remoto")
    print("para servi√ßos Quality")
    print("=" * 60)
    print()

def check_python_version():
    """Verifica vers√£o do Python"""
    print("üêç Verificando vers√£o do Python...")
    
    if sys.version_info < (3, 7):
        print("‚ùå Python 3.7 ou superior √© necess√°rio")
        print(f"   Vers√£o atual: {sys.version}")
        return False
    
    print(f"‚úÖ Python {sys.version.split()[0]} - OK")
    return True

def check_quality_installation():
    """Verifica se o Quality est√° instalado"""
    print("\nüîç Verificando instala√ß√£o do Quality...")
    
    quality_paths = [
        "C:\\Quality",
        "D:\\Quality",
        "E:\\Quality"
    ]
    
    quality_found = False
    for path in quality_paths:
        if os.path.exists(path):
            print(f"‚úÖ Quality encontrado em: {path}")
            quality_found = True
            break
    
    if not quality_found:
        print("‚ö†Ô∏è  Quality n√£o encontrado nos caminhos padr√£o")
        print("   Caminhos verificados:")
        for path in quality_paths:
            print(f"   - {path}")
        print("\n   Voc√™ pode continuar a instala√ß√£o e configurar os caminhos manualmente.")
    
    return quality_found

def check_quality_services():
    """Verifica quais servi√ßos Quality est√£o instalados"""
    print("\nüîß Verificando servi√ßos Quality instalados...")
    
    services_config = {
        "srvIntegraWeb": {
            "name": "IntegraWebService",
            "executable_path": "C:\\Quality\\web\\IntegraWebService.exe",
            "log_base_path": "C:\\Quality\\LOG\\Integra",
            "description": "Servi√ßo de Integra√ß√£o Web do Quality"
        },
        "ServicoFiscal": {
            "name": "webPostoFiscalService",
            "executable_path": "C:\\Quality\\Services\\webPostoPayServer\\webPostoFiscalServer.exe",
            "log_base_path": "C:\\Quality\\LOG\\webPostoFiscalServer",
            "description": "Servi√ßo Fiscal do WebPosto"
        },
        "ServicoAutomacao": {
            "name": "webPostoLeituraAutomacao",
            "executable_path": "C:\\Quality\\Services\\webPostoLeituraAutomacao\\webPostoLeituraAutomacao.exe",
            "log_base_path": "C:\\Quality\\LOG\\webPostoLeituraAutomacao",
            "description": "Servi√ßo de Automa√ß√£o e Leitura"
        },
        "webPostoPayServer": {
            "name": "webPostoPayServer",
            "executable_path": "C:\\Quality\\Services\\webPostoPayServer\\winSW\\webPostoPaySW.exe",
            "log_base_path": "C:\\Quality\\LOG\\QualityPDV_PAF",
            "description": "Servidor de Pagamento WebPosto"
        },
        "QualityPulser": {
            "name": "QualityPulserWeb",
            "executable_path": "C:\\Quality\\PulserWeb.exe",
            "log_base_path": "C:\\Quality\\LOG\\WebPostoPulser",
            "description": "Quality Pulser Web Service"
        }
    }
    
    installed_services = []
    missing_services = []
    
    for service_id, service_info in services_config.items():
        executable_path = service_info["executable_path"]
        
        if os.path.exists(executable_path):
            print(f"‚úÖ {service_info['name']} - Encontrado")
            installed_services.append({
                "name": service_id,
                "display_name": service_info["name"],
                "executable_path": executable_path,
                "log_base_path": service_info["log_base_path"],
                "log_structure": "nested_numeric_folders",
                "log_file_pattern": "*.txt",
                "description": service_info["description"],
                "enabled": True
            })
        else:
            print(f"‚ùå {service_info['name']} - N√£o encontrado")
            missing_services.append(service_info["name"])
    
    print(f"\nüìä Resumo:")
    print(f"   ‚úÖ Servi√ßos instalados: {len(installed_services)}")
    print(f"   ‚ùå Servi√ßos n√£o encontrados: {len(missing_services)}")
    
    if missing_services:
        print(f"\n‚ö†Ô∏è  Servi√ßos n√£o encontrados:")
        for service in missing_services:
            print(f"   - {service}")
        print("\n   Estes servi√ßos n√£o ser√£o monitorados.")
        print("   Voc√™ pode adicion√°-los manualmente ap√≥s a instala√ß√£o.")
    
    return installed_services, missing_services

def get_client_configuration():
    """Obt√©m configura√ß√£o do cliente"""
    print("\n‚öôÔ∏è  Configura√ß√£o do Cliente")
    print("-" * 40)
    
    # ID do cliente
    while True:
        client_id = input("ID do Cliente (ex: QUALITY_CLIENTE_001): ").strip()
        if client_id and client_id.startswith("QUALITY_CLIENTE_"):
            break
        print("‚ùå ID deve come√ßar com 'QUALITY_CLIENTE_'")
    
    # Nome do cliente
    client_name = input("Nome do Cliente (ex: Posto Quality - Terminal 01): ").strip()
    if not client_name:
        client_name = f"Cliente {client_id}"
    
    # Localiza√ß√£o
    location = input("Localiza√ß√£o (ex: Matriz, Filial 01): ").strip()
    if not location:
        location = "N√£o informado"
    
    # Servidor
    print("\nüåê Configura√ß√£o do Servidor")
    server_host = input("IP do Servidor (padr√£o: 192.168.1.100): ").strip()
    if not server_host:
        server_host = "192.168.1.100"
    
    server_port = input("Porta do Servidor (padr√£o: 8765): ").strip()
    if not server_port:
        server_port = "8765"
    
    try:
        server_port = int(server_port)
    except ValueError:
        server_port = 8765
    
    return {
        "client_id": client_id,
        "client_name": client_name,
        "location": location,
        "server_host": server_host,
        "server_port": server_port
    }

def create_client_config(installed_services: List[Dict[str, Any]], client_config: Dict[str, Any]) -> Dict[str, Any]:
    """Cria configura√ß√£o do cliente"""
    config = {
        "services": installed_services,
        "server": {
            "host": client_config["server_host"],
            "port": client_config["server_port"],
            "reconnect_interval": 5,
            "heartbeat_interval": 30
        },
        "client": {
            "id": client_config["client_id"],
            "name": client_config["client_name"],
            "location": client_config["location"]
        },
        "log_monitoring": {
            "refresh_interval": 1,
            "max_lines_buffer": 1000,
            "encoding": "utf-8"
        },
        "service_dependencies": {
            "ServicoFiscal": ["srvIntegraWeb"],
            "ServicoAutomacao": ["srvIntegraWeb", "ServicoFiscal"],
            "webPostoPayServer": ["ServicoFiscal"],
            "QualityPulser": ["srvIntegraWeb"]
        },
        "startup_order": [
            "srvIntegraWeb",
            "ServicoFiscal",
            "ServicoAutomacao",
            "webPostoPayServer",
            "QualityPulser"
        ]
    }
    
    return config

def install_dependencies():
    """Instala depend√™ncias Python"""
    print("\nüì¶ Instalando depend√™ncias...")
    
    try:
        # Verificar se pip est√° dispon√≠vel
        subprocess.run([sys.executable, "-m", "pip", "--version"], 
                      check=True, capture_output=True)
        
        # Instalar depend√™ncias
        requirements_file = Path(__file__).parent / "cliente_agent" / "requirements.txt"
        
        if requirements_file.exists():
            print("   Instalando depend√™ncias do cliente...")
            subprocess.run([
                sys.executable, "-m", "pip", "install", "-r", str(requirements_file)
            ], check=True)
            print("‚úÖ Depend√™ncias instaladas com sucesso")
        else:
            print("‚ö†Ô∏è  Arquivo requirements.txt n√£o encontrado")
            print("   Instalando depend√™ncias b√°sicas...")
            
            basic_deps = [
                "websocket-client==1.6.4",
                "psutil==5.9.6",
                "requests==2.31.0",
                "colorama==0.4.6"
            ]
            
            for dep in basic_deps:
                subprocess.run([sys.executable, "-m", "pip", "install", dep], check=True)
            
            print("‚úÖ Depend√™ncias b√°sicas instaladas")
        
        return True
        
    except subprocess.CalledProcessError as e:
        print(f"‚ùå Erro ao instalar depend√™ncias: {e}")
        return False
    except Exception as e:
        print(f"‚ùå Erro inesperado: {e}")
        return False

def create_installation_directory():
    """Cria diret√≥rio de instala√ß√£o"""
    print("\nüìÅ Criando diret√≥rio de instala√ß√£o...")
    
    install_dir = Path("C:\\Quality\\RemoteAgent")
    
    try:
        install_dir.mkdir(parents=True, exist_ok=True)
        print(f"‚úÖ Diret√≥rio criado: {install_dir}")
        return install_dir
    except Exception as e:
        print(f"‚ùå Erro ao criar diret√≥rio: {e}")
        return None

def copy_agent_files(install_dir: Path):
    """Copia arquivos do agente"""
    print("\nüìã Copiando arquivos do agente...")
    
    source_dir = Path(__file__).parent / "cliente_agent"
    
    try:
        # Copiar arquivos principais
        files_to_copy = [
            "main.py",
            "requirements.txt"
        ]
        
        for file_name in files_to_copy:
            source_file = source_dir / file_name
            if source_file.exists():
                shutil.copy2(source_file, install_dir / file_name)
                print(f"   ‚úÖ {file_name}")
        
        # Copiar diret√≥rios
        dirs_to_copy = ["config", "core", "utils"]
        
        for dir_name in dirs_to_copy:
            source_dir_path = source_dir / dir_name
            if source_dir_path.exists():
                dest_dir_path = install_dir / dir_name
                if dest_dir_path.exists():
                    shutil.rmtree(dest_dir_path)
                shutil.copytree(source_dir_path, dest_dir_path)
                print(f"   ‚úÖ {dir_name}/")
        
        print("‚úÖ Arquivos copiados com sucesso")
        return True
        
    except Exception as e:
        print(f"‚ùå Erro ao copiar arquivos: {e}")
        return False

def save_client_config(install_dir: Path, config: Dict[str, Any]):
    """Salva configura√ß√£o do cliente"""
    print("\nüíæ Salvando configura√ß√£o...")
    
    try:
        config_file = install_dir / "config" / "services_config.json"
        config_file.parent.mkdir(exist_ok=True)
        
        with open(config_file, 'w', encoding='utf-8') as f:
            json.dump(config, f, indent=4, ensure_ascii=False)
        
        print(f"‚úÖ Configura√ß√£o salva: {config_file}")
        return True
        
    except Exception as e:
        print(f"‚ùå Erro ao salvar configura√ß√£o: {e}")
        return False

def create_startup_script(install_dir: Path):
    """Cria script de inicializa√ß√£o"""
    print("\nüöÄ Criando script de inicializa√ß√£o...")
    
    try:
        # Script batch para Windows
        batch_content = f"""@echo off
echo Iniciando Quality Remote Agent...
cd /d "{install_dir}"
python main.py
pause
"""
        
        batch_file = install_dir / "start_agent.bat"
        with open(batch_file, 'w', encoding='utf-8') as f:
            f.write(batch_content)
        
        print(f"‚úÖ Script criado: {batch_file}")
        
        # Script Python para inicializa√ß√£o
        python_content = f"""#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import sys
import os
sys.path.append(r"{install_dir}")
os.chdir(r"{install_dir}")
from main import main
if __name__ == "__main__":
    main()
"""
        
        python_file = install_dir / "start_agent.py"
        with open(python_file, 'w', encoding='utf-8') as f:
            f.write(python_content)
        
        print(f"‚úÖ Script Python criado: {python_file}")
        return True
        
    except Exception as e:
        print(f"‚ùå Erro ao criar scripts: {e}")
        return False

def create_uninstall_script(install_dir: Path):
    """Cria script de desinstala√ß√£o"""
    print("\nüóëÔ∏è  Criando script de desinstala√ß√£o...")
    
    try:
        uninstall_content = f"""@echo off
echo Desinstalando Quality Remote Agent...
echo.
echo Tem certeza que deseja remover o Quality Remote Agent?
echo Pressione qualquer tecla para continuar ou Ctrl+C para cancelar...
pause >nul

echo Removendo arquivos...
cd /d "{install_dir.parent}"
rmdir /s /q "{install_dir.name}"

echo.
echo Quality Remote Agent foi removido com sucesso!
pause
"""
        
        uninstall_file = install_dir / "uninstall.bat"
        with open(uninstall_file, 'w', encoding='utf-8') as f:
            f.write(uninstall_content)
        
        print(f"‚úÖ Script de desinstala√ß√£o criado: {uninstall_file}")
        return True
        
    except Exception as e:
        print(f"‚ùå Erro ao criar script de desinstala√ß√£o: {e}")
        return False

def test_installation(install_dir: Path):
    """Testa a instala√ß√£o"""
    print("\nüß™ Testando instala√ß√£o...")
    
    try:
        # Testar importa√ß√£o dos m√≥dulos
        test_script = f"""
import sys
sys.path.append(r"{install_dir}")

try:
    from config.settings import load_config
    from core.agent import QualityAgent
    from utils.logger import setup_logger
    print("‚úÖ M√≥dulos importados com sucesso")
except Exception as e:
    print(f"‚ùå Erro ao importar m√≥dulos: {{e}}")
    sys.exit(1)

# Testar carregamento de configura√ß√£o
try:
    config = load_config(r"{install_dir}/config/services_config.json")
    print("‚úÖ Configura√ß√£o carregada com sucesso")
    print(f"   Cliente: {{config['client']['name']}}")
    print(f"   Servi√ßos: {{len(config['services'])}}")
except Exception as e:
    print(f"‚ùå Erro ao carregar configura√ß√£o: {{e}}")
    sys.exit(1)

print("‚úÖ Teste de instala√ß√£o conclu√≠do com sucesso!")
"""
        
        result = subprocess.run([
            sys.executable, "-c", test_script
        ], capture_output=True, text=True)
        
        if result.returncode == 0:
            print("‚úÖ Teste de instala√ß√£o passou")
            return True
        else:
            print("‚ùå Teste de instala√ß√£o falhou")
            print(result.stdout)
            print(result.stderr)
            return False
            
    except Exception as e:
        print(f"‚ùå Erro no teste: {e}")
        return False

def main():
    """Fun√ß√£o principal de instala√ß√£o"""
    print_banner()
    
    # Verifica√ß√µes iniciais
    if not check_python_version():
        input("\nPressione Enter para sair...")
        return False
    
    # Verificar instala√ß√£o do Quality
    quality_found = check_quality_installation()
    
    # Verificar servi√ßos instalados
    installed_services, missing_services = check_quality_services()
    
    if not installed_services:
        print("\n‚ùå Nenhum servi√ßo Quality encontrado!")
        print("   Verifique se o Quality est√° instalado corretamente.")
        input("\nPressione Enter para sair...")
        return False
    
    # Obter configura√ß√£o do cliente
    client_config = get_client_configuration()
    
    # Instalar depend√™ncias
    if not install_dependencies():
        print("\n‚ùå Falha na instala√ß√£o das depend√™ncias")
        input("\nPressione Enter para sair...")
        return False
    
    # Criar diret√≥rio de instala√ß√£o
    install_dir = create_installation_directory()
    if not install_dir:
        input("\nPressione Enter para sair...")
        return False
    
    # Copiar arquivos
    if not copy_agent_files(install_dir):
        input("\nPressione Enter para sair...")
        return False
    
    # Criar configura√ß√£o
    config = create_client_config(installed_services, client_config)
    
    # Salvar configura√ß√£o
    if not save_client_config(install_dir, config):
        input("\nPressione Enter para sair...")
        return False
    
    # Criar scripts
    create_startup_script(install_dir)
    create_uninstall_script(install_dir)
    
    # Testar instala√ß√£o
    if not test_installation(install_dir):
        print("\n‚ö†Ô∏è  Instala√ß√£o conclu√≠da, mas teste falhou")
        print("   Verifique os logs para mais detalhes")
    
    # Resumo final
    print("\n" + "=" * 60)
    print("üéâ INSTALA√á√ÉO CONCLU√çDA COM SUCESSO!")
    print("=" * 60)
    print(f"üìÅ Diret√≥rio: {install_dir}")
    print(f"üë§ Cliente: {client_config['client_name']} ({client_config['client_id']})")
    print(f"üåê Servidor: {client_config['server_host']}:{client_config['server_port']}")
    print(f"üîß Servi√ßos monitorados: {len(installed_services)}")
    
    if missing_services:
        print(f"‚ö†Ô∏è  Servi√ßos n√£o encontrados: {len(missing_services)}")
    
    print("\nüìã Pr√≥ximos passos:")
    print("1. Inicie o servidor de controle")
    print("2. Execute o agente: start_agent.bat")
    print("3. Verifique a conex√£o no painel de controle")
    
    print(f"\nüöÄ Para iniciar o agente:")
    print(f"   {install_dir}\\start_agent.bat")
    
    print(f"\nüóëÔ∏è  Para desinstalar:")
    print(f"   {install_dir}\\uninstall.bat")
    
    input("\nPressione Enter para finalizar...")
    return True

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nüëã Instala√ß√£o cancelada pelo usu√°rio")
    except Exception as e:
        print(f"\n‚ùå Erro inesperado durante a instala√ß√£o: {e}")
        input("\nPressione Enter para sair...")
