#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Script de Teste Completo - Sistema Quality Control Panel
Testa todos os componentes do sistema
"""

import os
import sys
import subprocess
import time
import threading
from pathlib import Path

def print_banner():
    """Exibe banner de teste"""
    print("=" * 70)
    print("üß™ QUALITY CONTROL PANEL - TESTE COMPLETO DO SISTEMA")
    print("=" * 70)
    print("Testando todos os componentes instalados")
    print("=" * 70)
    print()

def test_dependencies():
    """Testa depend√™ncias Python"""
    print("üì¶ Testando depend√™ncias Python...")
    
    deps = [
        ("websocket", "websocket-client"),
        ("websocket_server", "websocket-server"),
        ("colorama", "colorama"),
        ("rich", "rich"),
        ("requests", "requests")
    ]
    
    success = True
    for module, package in deps:
        try:
            __import__(module)
            print(f"   ‚úÖ {package}")
        except ImportError:
            print(f"   ‚ùå {package} - N√ÉO INSTALADO")
            success = False
    
    return success

def test_directories():
    """Testa diret√≥rios de instala√ß√£o"""
    print("\nüìÅ Testando diret√≥rios de instala√ß√£o...")
    
    directories = [
        ("C:\\Quality\\ControlPanel", "Servidor"),
        ("C:\\Quality\\AttendantClient", "Atendentes"),
        ("C:\\Quality\\RemoteAgent", "Clientes"),
        ("C:\\Quality\\Documentation", "Documenta√ß√£o")
    ]
    
    success = True
    for directory, description in directories:
        if os.path.exists(directory):
            print(f"   ‚úÖ {description}: {directory}")
        else:
            print(f"   ‚ùå {description}: {directory} - N√ÉO ENCONTRADO")
            success = False
    
    return success

def test_server_files():
    """Testa arquivos do servidor"""
    print("\nüñ•Ô∏è  Testando arquivos do servidor...")
    
    server_files = [
        "main.py",
        "config/server_config.json",
        "config/users_config.json",
        "core/server.py",
        "core/session_manager.py",
        "core/attendant_manager.py",
        "utils/auth.py",
        "start_server.bat"
    ]
    
    success = True
    for file in server_files:
        file_path = os.path.join("C:\\Quality\\ControlPanel", file)
        if os.path.exists(file_path):
            print(f"   ‚úÖ {file}")
        else:
            print(f"   ‚ùå {file} - N√ÉO ENCONTRADO")
            success = False
    
    return success

def test_attendant_files():
    """Testa arquivos dos atendentes"""
    print("\nüë• Testando arquivos dos atendentes...")
    
    attendant_files = [
        "attendant_client.py",
        "start_attendant.bat"
    ]
    
    success = True
    for file in attendant_files:
        file_path = os.path.join("C:\\Quality\\AttendantClient", file)
        if os.path.exists(file_path):
            print(f"   ‚úÖ {file}")
        else:
            print(f"   ‚ùå {file} - N√ÉO ENCONTRADO")
            success = False
    
    return success

def test_client_files():
    """Testa arquivos dos clientes"""
    print("\nüñ•Ô∏è  Testando arquivos dos clientes...")
    
    client_files = [
        "quality_agent.py",
        "start_agent.bat"
    ]
    
    success = True
    for file in client_files:
        file_path = os.path.join("C:\\Quality\\RemoteAgent", file)
        if os.path.exists(file_path):
            print(f"   ‚úÖ {file}")
        else:
            print(f"   ‚ùå {file} - N√ÉO ENCONTRADO")
            success = False
    
    return success

def test_server_imports():
    """Testa imports do servidor"""
    print("\nüîç Testando imports do servidor...")
    
    try:
        server_dir = "C:\\Quality\\ControlPanel"
        if os.path.exists(server_dir):
            sys.path.insert(0, server_dir)
            
            # Testar imports principais
            from config.settings import load_config
            print("   ‚úÖ config.settings")
            
            from utils.auth import QualityAuthManager
            print("   ‚úÖ utils.auth")
            
            from core.session_manager import SessionManager
            print("   ‚úÖ core.session_manager")
            
            from core.attendant_manager import AttendantManager
            print("   ‚úÖ core.attendant_manager")
            
            return True
        else:
            print("   ‚ùå Diret√≥rio do servidor n√£o encontrado")
            return False
            
    except Exception as e:
        print(f"   ‚ùå Erro ao importar m√≥dulos do servidor: {e}")
        return False

def test_server_config():
    """Testa configura√ß√£o do servidor"""
    print("\n‚öôÔ∏è  Testando configura√ß√£o do servidor...")
    
    try:
        server_dir = "C:\\Quality\\ControlPanel"
        if os.path.exists(server_dir):
            sys.path.insert(0, server_dir)
            
            from config.settings import load_config
            
            # Testar configura√ß√£o do servidor
            config_file = os.path.join(server_dir, "config", "server_config.json")
            if os.path.exists(config_file):
                config = load_config(config_file)
                print(f"   ‚úÖ Configura√ß√£o do servidor carregada")
                print(f"      Host: {config['server']['host']}")
                print(f"      Porta: {config['server']['port']}")
            else:
                print(f"   ‚ùå Arquivo de configura√ß√£o n√£o encontrado")
                return False
            
            # Testar configura√ß√£o de usu√°rios
            users_file = os.path.join(server_dir, "config", "users_config.json")
            if os.path.exists(users_file):
                from utils.auth import QualityAuthManager
                auth_manager = QualityAuthManager(users_file)
                users = auth_manager.get_all_users()
                print(f"   ‚úÖ Configura√ß√£o de usu√°rios carregada ({len(users)} usu√°rios)")
            else:
                print(f"   ‚ùå Arquivo de usu√°rios n√£o encontrado")
                return False
            
            return True
        else:
            print("   ‚ùå Diret√≥rio do servidor n√£o encontrado")
            return False
            
    except Exception as e:
        print(f"   ‚ùå Erro ao testar configura√ß√µes: {e}")
        return False

def test_network_connectivity():
    """Testa conectividade de rede"""
    print("\nüåê Testando conectividade de rede...")
    
    try:
        import socket
        
        # Testar porta 8765 (porta padr√£o do servidor)
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(5)
        
        # Tentar conectar na porta local
        result = sock.connect_ex(('localhost', 8765))
        sock.close()
        
        if result == 0:
            print("   ‚úÖ Porta 8765 est√° em uso (servidor pode estar rodando)")
        else:
            print("   ‚ÑπÔ∏è  Porta 8765 est√° livre (servidor n√£o est√° rodando)")
        
        return True
        
    except Exception as e:
        print(f"   ‚ùå Erro ao testar conectividade: {e}")
        return False

def test_python_scripts():
    """Testa scripts Python"""
    print("\nüêç Testando scripts Python...")
    
    scripts = [
        ("C:\\Quality\\ControlPanel\\main.py", "Servidor"),
        ("C:\\Quality\\AttendantClient\\attendant_client.py", "Atendente"),
        ("C:\\Quality\\RemoteAgent\\quality_agent.py", "Cliente")
    ]
    
    success = True
    for script_path, description in scripts:
        if os.path.exists(script_path):
            try:
                # Testar sintaxe do script
                with open(script_path, 'r', encoding='utf-8') as f:
                    script_content = f.read()
                
                # Compilar para verificar sintaxe
                compile(script_content, script_path, 'exec')
                print(f"   ‚úÖ {description}: {os.path.basename(script_path)}")
                
            except SyntaxError as e:
                print(f"   ‚ùå {description}: Erro de sintaxe em {os.path.basename(script_path)}")
                print(f"      Linha {e.lineno}: {e.msg}")
                success = False
            except Exception as e:
                print(f"   ‚ùå {description}: Erro ao testar {os.path.basename(script_path)}: {e}")
                success = False
        else:
            print(f"   ‚ùå {description}: {os.path.basename(script_path)} - N√ÉO ENCONTRADO")
            success = False
    
    return success

def test_batch_scripts():
    """Testa scripts batch"""
    print("\nüìú Testando scripts batch...")
    
    batch_scripts = [
        ("C:\\Quality\\ControlPanel\\start_server.bat", "Servidor"),
        ("C:\\Quality\\AttendantClient\\start_attendant.bat", "Atendente"),
        ("C:\\Quality\\RemoteAgent\\start_agent.bat", "Cliente")
    ]
    
    success = True
    for script_path, description in batch_scripts:
        if os.path.exists(script_path):
            print(f"   ‚úÖ {description}: {os.path.basename(script_path)}")
        else:
            print(f"   ‚ùå {description}: {os.path.basename(script_path)} - N√ÉO ENCONTRADO")
            success = False
    
    return success

def test_documentation():
    """Testa documenta√ß√£o"""
    print("\nüìö Testando documenta√ß√£o...")
    
    doc_files = [
        "README.txt"
    ]
    
    success = True
    for file in doc_files:
        file_path = os.path.join("C:\\Quality\\Documentation", file)
        if os.path.exists(file_path):
            print(f"   ‚úÖ {file}")
        else:
            print(f"   ‚ùå {file} - N√ÉO ENCONTRADO")
            success = False
    
    return success

def run_comprehensive_test():
    """Executa teste abrangente"""
    print("üöÄ Executando teste abrangente...")
    
    tests = [
        ("Depend√™ncias Python", test_dependencies),
        ("Diret√≥rios de Instala√ß√£o", test_directories),
        ("Arquivos do Servidor", test_server_files),
        ("Arquivos dos Atendentes", test_attendant_files),
        ("Arquivos dos Clientes", test_client_files),
        ("Imports do Servidor", test_server_imports),
        ("Configura√ß√£o do Servidor", test_server_config),
        ("Conectividade de Rede", test_network_connectivity),
        ("Scripts Python", test_python_scripts),
        ("Scripts Batch", test_batch_scripts),
        ("Documenta√ß√£o", test_documentation)
    ]
    
    results = []
    for test_name, test_func in tests:
        try:
            result = test_func()
            results.append((test_name, result))
        except Exception as e:
            print(f"   ‚ùå Erro no teste {test_name}: {e}")
            results.append((test_name, False))
    
    return results

def main():
    """Fun√ß√£o principal"""
    print_banner()
    
    # Executar testes
    results = run_comprehensive_test()
    
    # Resumo dos resultados
    print("\n" + "=" * 70)
    print("üìä RESUMO DOS TESTES")
    print("=" * 70)
    
    passed = 0
    total = len(results)
    
    for test_name, result in results:
        status = "‚úÖ PASSOU" if result else "‚ùå FALHOU"
        print(f"   {status} - {test_name}")
        if result:
            passed += 1
    
    print("=" * 70)
    print(f"üìà RESULTADO GERAL: {passed}/{total} testes passaram")
    
    if passed == total:
        print("üéâ TODOS OS TESTES PASSARAM!")
        print("‚úÖ O sistema est√° funcionando corretamente")
        print("‚úÖ Todos os componentes est√£o instalados")
        print("‚úÖ Todas as configura√ß√µes est√£o corretas")
        print()
        print("üöÄ O sistema est√° pronto para uso!")
        print("   Execute: C:\\Quality\\ControlPanel\\start_server.bat")
    elif passed >= total * 0.8:
        print("‚ö†Ô∏è  MAIORIA DOS TESTES PASSOU")
        print("‚úÖ O sistema est√° funcionando com pequenos problemas")
        print("‚ö†Ô∏è  Verifique os itens que falharam")
        print("üí° O sistema pode funcionar normalmente")
    else:
        print("‚ùå MUITOS TESTES FALHARAM")
        print("‚ùå O sistema pode n√£o estar funcionando corretamente")
        print("üîß Execute: python fix_installation.py")
        print("üîÑ Ou reinstale o sistema")
    
    print("=" * 70)
    
    input("\nPressione Enter para finalizar...")
    return passed == total

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nüëã Teste cancelado pelo usu√°rio")
    except Exception as e:
        print(f"\n‚ùå Erro inesperado durante o teste: {e}")
        input("\nPressione Enter para sair...")
